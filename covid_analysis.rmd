title: "COVID_TEMP_HOSP_ANALYSIS"
author: "
  Michael NYANYUIE,
  Divine IZERE
  Lucky BERNICE
  Medhi 
  Rayane "
date: "2024-03-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction
------------

This analysis aims to explore the relationship between temperature variations and hospitalization rates during the years significantly impacted by the COVID-19 pandemic, 2019 and 2020. Although direct data on COVID-19 infections are not available in our dataset, we investigate if environmental factors, such as temperature, as recorded in our `TEMPERATURES` database, could correlate with changes in hospitalization patterns observed in the `HOSPITALISATIONS` table.

```{r database access}
library(RMariaDB)

password <- rstudioapi::askForPassword("UT2J Password")
connection <- dbConnect(
  drv = RMariaDB::MariaDB(),
  user = "michael-kofi.nyanyui",
  password = password,
  dbname = "23_2L2_michael_kofi_nyanyuie",
  host = "10.10.190.39",
  port = 3306
)
```

## DATABASE CREATION.
```{r DATABASE CREATION in SQL}
#### TEMPERATURES TABLE
CREATE TABLE TEMPERATURES(
  DATE_TEMP DATE,
  DEP_ID VARCHAR(3),
  DEPARTMENT VARCHAR(50),
  MIN_TEMP DECIMAL(10, 2),
  MAX_TEMP DECIMAL(10, 2),
  MEAN_TEMP DECIMAL(10, 2),

  PRIMARY KEY (DATE_TEMP, DEP_ID),
  FOREIGN KEY (DEP_ID) REFERENCES PROJECT_DEP(codeD)
);

#### HOSPITALISATIONS TABLE
CREATE TABLE HOSPITALISATIONS(
  DEP_ID VARCHAR(3),
  SEX INT,
  DATE_HOSP DATE,
  NUM_HOSP INT,
  NUM_INTENSE_CARE INT,
  NUM_CONV_HOSP INT,
  NUM_SSR_USLD INT,
  NUM_OTHERS INT,
  NUM_RETURN_HOME INT,
  NUM_DEATHS INT,

  PRIMARY KEY (DEP_ID, DATE_HOSP, SEX),
  FOREIGN KEY (DEP_ID) REFERENCES PROJECT_DEP (codeD)
);
```
## STUDY OF HOSPITALISATION VARIABLE

We would like to study the hospitalisation rates by seasons

```{r HOSPITALISATION RATE BY SEASON}
hosp_rate_10K <- dbGetQuery(
  connection,
  "SELECT
    AVG((NUM_HOSP/total) * 10000) AS HOSP_RATE,
    CASE
      WHEN MONTH(DATE_HOSP) IN (12, 1, 2) THEN 'Winter'
      WHEN MONTH(DATE_HOSP) IN (3, 4, 5) THEN 'Spring'
      WHEN MONTH(DATE_HOSP) IN (6, 7, 8) THEN 'Summer'
      WHEN MONTH(DATE_HOSP) IN (9, 10, 11) THEN 'Autumn'
    END AS 'SEASONS'
  FROM HOSPITALISATIONS H
  INNER JOIN PROJECT_POPU P
    ON H.DEP_ID = P.codeD
  GROUP BY SEASONS
  ORDER BY HOSP_RATE DESC"
)

print(hosp_rate_10K)
```
We then notice a high rate of hospitalisation in Winter and colder seasons than in Summer.

## CORRELATION COEFFICIENT BETWEEN TEMPERATURE AND HOSPITALISATION RATES

```{r CORRELATION GRAPH (TEMP vs HOSP RATE), echo=FALSE}
temps_hosp_data <- dbSendQuery(
  connection,
  "SELECT MEAN_TEMP, ((NUM_HOSP/total) * 10000) AS HOSP_RATE_10K
  FROM TEMPERATURES T
  RIGHT JOIN HOSPITALISATIONS H
    ON H.DEP_ID = T.DEP_ID AND H.DATE_HOSP = T.DATE_TEMP
  INNER JOIN PROJECT_POPU P
    ON P.codeD = H.DEP_ID
  WHERE SEX = 0 AND T.DEP_ID IS NOT NULL AND H.DATE_HOSP IS NOT NULL
  GROUP BY DATE_TEMP
  ORDER BY HOSP_RATE_10K DESC, MEAN_TEMP DESC"
)

cor_hosp_temp <- cor(
  temps_hosp_data$MEAN_TEMP,
  temps_hosp_data$HOSP_RATE_10K
)

plot(
  temps_hosp_data$MEAN_TEMP,
  temps_hosp_data$HOSP_RATE_10K,
  main = "SCATTER PLOT OF TEMP VS HOSPITALISATION RATE",
  xlab = "AVERAGE TEMPERATURES",
  ylab = "HOSPITALISATION RATE PER 10K",
  pch = 20
)
```
I used 10,000 inhabitants as a reference to standardize the hospitalisation rate. According to the correlation coefficient calculation, which is -0.21, there is a weak negative relationship between the temperature and the hospitalisation rate. This suggests a slight tendency for hospitalisations to decrease as temperatures rise. However, this relationship is weak and indicates that other factors may play a more significant role in hospitalisation rates. This analysis sheds light on the complexity of factors affecting hospitalisations.


## CDD/HDD Index
```{r CDD/HDD INDEX GRAPH}
cdd_hdd_query <- "
WITH HEATING_DAYS AS(
  SELECT SUM(18 - MEAN_TEMP) AS HDD, YEAR(DATE_TEMP) AS YEARS
  FROM TEMPERATURES
  WHERE MEAN_TEMP < 18
  GROUP BY YEARS
), COOLING_DAYS AS(
  SELECT SUM(MEAN_TEMP - 18) AS CDD, YEAR(DATE_TEMP) AS YEARS
  FROM TEMPERATURES
  WHERE MEAN_TEMP > 18
  GROUP BY YEARS
) 

SELECT
  YEAR(T.DATE_TEMP) AS YEARS,
  CD.CDD/HD.HDD AS `CDD/HDD INDEX`
FROM TEMPERATURES T
LEFT JOIN HEATING_DAYS HD
  ON YEAR(T.DATE_TEMP) = HD.YEARS
LEFT JOIN COOLING_DAYS CD
  ON CD.YEARS = YEAR(T.DATE_TEMP)
GROUP BY YEARS
ORDER BY YEARS ASC
"

cdd_hdd_data <- dbGetQuery(connection, cdd_hdd_query)

cdd_hdd_data$YEARS <- as.factor(cdd_hdd_data$YEARS)

plot(cdd_hdd_data$YEARS, cdd_hdd_data$`CDD/HDD INDEX`,
  type = "b",
  pch = 19,
  lty = 1,
  xlab = "Year",
  ylab = "CDD/HDD Index",
  main = "CDD/HDD Index Over Years"
)

```
The CDD/HDD index from 2018 to 2021 partially reflects the weak negative correlation found between temperatures and hospitalisations. We observe that buildings required more heating between 2018 and 2020, indicating generally lower temperatures, while the CDD and HDD indices tend to converge in 2021, indicating a year with relatively more balanced temperatures. However, given the weak correlation between temperature and hospitalisation rates, it would be premature to directly conclude that COVID-19 cases have decreased over the years based solely on this index.